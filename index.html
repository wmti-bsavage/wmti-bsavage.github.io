<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. -->
<!DOCTYPE html>
<html>

<head>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

</head>

<body>

    <p>V0.15</p>
    <p>This add-in corrects the formatting of any UNC Paths pointing to the Sales&Quoting directory.<br></p>
    <p id="uncPath"></p>
    <button onclick="copyToClipboard()">Copy Link</button>
    <p id="copyConfirmation"></p>
    <p id="numberOfPaths"></p>

</body>

</html>

<script>
    
    const searchStr = "Sales&Quoteing";
    const newServerName = "\\\\wmtinas";

    function copyToClipboard() 
    {
        // Copy path to clipboard
        const copyText = document.getElementById('uncPath').innerText;
        navigator.clipboard.writeText(copyText);
        document.getElementById('copyConfirmation').innerText = "Link Copied!";
    }
    
    function itemChanged(eventArgs) 
    {
        // Update UI based on the new current item
        UpdateTaskPaneUI(Office.context.mailbox.item);
    }

    function UpdateTaskPaneUI(item) 
    {
        // Assuming that item is always a read item (instead of a compose item).
        if (item != null) {
            
            var body = Office.context.mailbox.item.body;
            // Get the body as text
            body.getAsync(Office.CoercionType.Text, function (asyncResult) 
            {
                if (asyncResult.status !== Office.AsyncResultStatus.Succeeded) 
                {
                    // do something with the error
                }
                else 
                {    
                    FindAndFormatPath(asyncResult);
                }
            });
        }
    }

    function FindAndFormatPath(asyncResult) 
    {
        var result = asyncResult.value;
        console.log("Initiating sequence...");
        
        // Check if the Sales&Quoteing directory is referenced in the email body
        if(result.includes(searchStr))
        {
            // Get the index of each link, store each link in an array
            var startingRegExp = /<\\\\/g;
            const pathStartingIndexes = [];
            var counter = 0;

            while ((match = startingRegExp.exec(result)) != null) 
            {
                pathStartingIndexes[counter] = match.index;
                counter++;
                console.log("Starting matches found: " + pathStartingIndexes.length);
            }

            var endingRegExp = /.xlsx/g;
            const pathEndingIndexes = [];
            counter = 0;

            while ((match = endingRegExp.exec(result)) != null) 
            {
                pathEndingIndexes[counter] = match.index;
                counter++;
                console.log("Ending matches found: " + pathEndingIndexes.length);
            }
            
            // Determine the number of links in the email body
            var numberOfPaths = (result.match(/<\\\\/g) || []).length;
            const uncPaths = [];

            for(let i = 0; i < numberOfPaths; i++) 
            {
                uncPaths[i] = result.substring(pathStartingIndexes[i] + 3, pathEndingIndexes[i] + 5);
                var serverName = uncPaths[i].substring(0, uncPath.indexOf("\\"));
                uncPaths[i].replace(serverName, newServerName);
            }

            // Compare the elements of the array and remove any duplicates
            // Format each element of the array
            // Create a p element and a corresponding copy button for each element in the array
            document.getElementById("uncPath").innerHTML = "Match found.";
            document.getElementById("numberOfPaths").innerHTML = pathEndingIndexes[0];

            // TODO: Only show unique paths (sometimes duplicated in the body from a reply thread)

            // Find the UNC path
            // var uncPath = result.substring(result.indexOf("<\\\\") + 3, result.indexOf(".xlsx>") + 5);
            // Find the server name within the UNC path 
            // var serverName = uncPath.substring(0, uncPath.indexOf("\\"));
            // Replace the server name with the new server name
            // uncPath = uncPath.replace(serverName, newServerName);
            
            // document.getElementById("uncPath").innerHTML = uncPath;
            //var links = [...result.matchAll(new RegExp(searchStr, 'gi'))].map(a => a.index)
            //document.getElementById("link").innerHTML = links;
        }
        else
        {
            document.getElementById("uncPath").innerHTML = "No match found.";
            document.getElementById("numberOfPaths").innerHTML = "";
        }
    }

    Office.onReady((info) => 
    {
        if (info.host === Office.HostType.Outlook) {

            // Set up ItemChanged event
            Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, itemChanged);

            UpdateTaskPaneUI(Office.context.mailbox.item);
        }
    });

</script>