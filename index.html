<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. -->
<!DOCTYPE html>
<html>

<head>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

</head>

<body>

    <p>V0.12</p>
    <p>This add-in corrects the formatting of any UNC Paths pointing to the Sales&Quoting directory.<br></p>
    <p id="uncPath"></p>
    <button onclick="copyToClipboard()">Copy Link</button>
    <p id="copyConfirmation"></p>
    <p id="numberOfPaths"></p>

</body>

</html>

<script>

    function copyToClipboard() 
    {
        // Copy path to clipboard
        const copyText = document.getElementById('uncPath').innerText;
        navigator.clipboard.writeText(copyText);
        document.getElementById('copyConfirmation').innerText = "Link Copied!";
    }
    
    function itemChanged(eventArgs) 
    {
        // Update UI based on the new current item
        UpdateTaskPaneUI(Office.context.mailbox.item);
    }

    function UpdateTaskPaneUI(item) 
    {
        // Assuming that item is always a read item (instead of a compose item).
        if (item != null) {
            
            var body = Office.context.mailbox.item.body;
            // Get the body as text
            body.getAsync(Office.CoercionType.Text, function (asyncResult) 
            {
                if (asyncResult.status !== Office.AsyncResultStatus.Succeeded) 
                {
                    // do something with the error
                }
                else 
                {    
                    findAndFormatPath(asyncResult);
                }
            });
        }
    }

    function findAndFormatPath(asyncResult) 
    {
        var result = asyncResult.value;
        const searchStr = "Sales&Quoteing";
        const newServerName = "\\\\wmtinas";
        
        // Check if the Sales&Quoteing directory is referenced in the email body
        if(result.includes(searchStr))
        {
            // Determine the number of links in the email body
            var numberOfPaths = (result.match(/<\\\\/g) || []).length;
            document.getElementById("numberOfPaths").innerHTML = numberOfPaths;

            // Find the UNC path
            var uncPath = result.substring(result.indexOf("<\\\\") + 3, result.indexOf(".xlsx>") + 5);
            // Find the server name within the UNC path 
            var serverName = uncPath.substring(0, uncPath.indexOf("\\"));
            // Replace the server name with the new server name
            uncPath = uncPath.replace(serverName, newServerName);
            
            document.getElementById("uncPath").innerHTML = uncPath;
            //var links = [...result.matchAll(new RegExp(searchStr, 'gi'))].map(a => a.index)
            //document.getElementById("link").innerHTML = links;
        }
        else
        {
            document.getElementById("uncPath").innerHTML = "No match found.";
        }
    }

    Office.onReady((info) => 
    {
        if (info.host === Office.HostType.Outlook) {

            // Set up ItemChanged event
            Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, itemChanged);

            UpdateTaskPaneUI(Office.context.mailbox.item);
        }
    });

</script>