<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. -->
<!DOCTYPE html>
<html>

<head>
    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
</head>

<body>
    <p>V0.13</p>
    <p>This add-in corrects the formatting of any UNC Paths pointing to the Sales&Quoting directory.</p>
    <p></p>
    <p><a id="uncPath" href="http://webermfg.ca">www.webermfg.ca</a></p>

</body>

</html>

<script>
    function itemChanged(eventArgs) {

        // Update UI based on the new current item
        UpdateTaskPaneUI(Office.context.mailbox.item);
    }

    function UpdateTaskPaneUI(item) {
        
        // Assuming that item is always a read item (instead of a compose item).
        if (item != null) {
            
            var body = Office.context.mailbox.item.body;
            // Get the body as text
            body.getAsync(Office.CoercionType.Text, function (asyncResult) 
            {
                if (asyncResult.status !== Office.AsyncResultStatus.Succeeded) 
                {
                    // do something with the error
                }
                else 
                {    
                    var result = asyncResult.value;
                    var searchStr = "Sales&Quoteing";
                    var newServerName = "<\\\\wmtinas\\";
                    
                    // Check if the Sales&Quoteing directory is referenced in the email body
                    if(result.includes(searchStr))
                    {
                        // Find the UNC path
                        var uncPath = result.substring(result.indexOf("<\\\\") + 3, result.indexOf(".xlsx>") + 1);
                        // Find the server name within the UNC path 
                        //var serverName = link.substring(0, link.indexOf("\\"));
                        // Replace the server name with the new server name
                        //uncPath = uncPath.replace(serverName, newServerName);
                        
                        document.getElementById("uncPath").innerHTML = uncPath;
                        //document.getElementById("uncPath").href = uncPath;
                        //var links = [...result.matchAll(new RegExp(searchStr, 'gi'))].map(a => a.index)
                        //document.getElementById("link").innerHTML = links;
                    }
                    else
                    {
                        document.getElementById("uncPath").innerHTML = "No match found.";
                    }
                }
            });
        }
    }

    Office.onReady((info) => {
        
        if (info.host === Office.HostType.Outlook) {

            // Set up ItemChanged event
            Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, itemChanged);

            UpdateTaskPaneUI(Office.context.mailbox.item);
        }
    });

</script>