<!-- Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT License. -->
<!DOCTYPE html>
<html>

<head>

    <!-- Office JavaScript API -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

</head>

<body>

    <p>V0.16</p>
    <p>This add-in corrects the formatting of any UNC Paths pointing to the Sales&Quoting directory.<br></p>
    <p id="uncPath"></p>
    <button onclick="CopyToClipboard()">Copy Link</button>
    <p id="copyConfirmation"></p>
    <p id="numberOfPaths"></p>
    <div id="div1">

    </div>

</body>

</html>

<script>
    
    const searchString = "Sales&Quoteing";
    var newServerName = "\\\\wmtinas";

    function CopyToClipboard() 
    {
        // Copy path to clipboard
        const copyText = document.getElementById('uncPath').innerText;
        navigator.clipboard.writeText(copyText);
        document.getElementById('copyConfirmation').innerText = "Link Copied!";
    }
    
    function ItemChanged(eventArgs) 
    {
        // Update UI based on the new current item
        UpdateTaskPaneUI(Office.context.mailbox.item);
    }

    function UpdateTaskPaneUI(item) 
    {
        // Assuming that item is always a read item (instead of a compose item).
        if (item != null) {
            
            var body = Office.context.mailbox.item.body;
            // Get the body as text
            body.getAsync(Office.CoercionType.Text, function (asyncResult) 
            {
                if (asyncResult.status !== Office.AsyncResultStatus.Succeeded) 
                {
                    // do something with the error
                }
                else 
                {    
                    FindAndFormatPath(asyncResult);
                }
            });
        }
    }

    function FindAndFormatPath(asyncResult) 
    {
        var result = asyncResult.value;
        console.log("Initiating sequence...");
        
        // Check if the Sales&Quoteing directory is referenced in the email body
        if(result.includes(searchString))
        {
            // Get the index of each link, store each link in an array
            var startingRegExp = /<\\\\/g;
            const pathStartingIndexes = [];
            var counter = 0;

            while ((matchStart = startingRegExp.exec(result)) != null) 
            {
                pathStartingIndexes[counter] = matchStart.index;
                counter++;
                
                console.log("Starting matches found: " + pathStartingIndexes.length + " - Position: " + matchStart.index);
            }

            var endingRegExp = /.xlsx/g;
            const pathEndingIndexes = [];
            counter = 0;

            while ((matchEnd = endingRegExp.exec(result)) != null) 
            {
                pathEndingIndexes[counter] = matchEnd.index;
                counter++;
                
                console.log("Ending matches found: " + pathEndingIndexes.length + " - Position: " + matchEnd.index);
            }
            
            // Determine the number of links in the email body
            var numberOfPaths = (result.match(/<\\\\/g) || []).length;
            
            console.log("Number of paths: " + numberOfPaths);
            
            // Format each element of the array
            
            const uncPaths = [];
            var serverName = "";

            for(let i = 0; i < numberOfPaths; i++) 
            {
                console.log("Initiating path building sequence...");
                
                uncPaths[i] = result.substring(pathStartingIndexes[i] + 1, pathEndingIndexes[i] + 5);
                console.log("Substring #" + (i + 1) + " created: " + uncPaths[i]);

                serverName = uncPaths[i].substring(0, uncPaths[i].indexOf("hared") - 2);
                console.log("Server name grabbed: " + serverName);

                if(serverName !== newServerName) 
                {
                    uncPaths[i] = uncPaths[i].replace(serverName, newServerName);
                }

                // Re-format old links with a lower-case "s" on shared
                if(uncPaths[i].includes("shared")) 
                {
                    uncPaths[i] = uncPaths[i].replace("shared", "Shared");
                }
                
                console.log("UNC Path #" + (i + 1) + ": " + uncPaths[i]);
            }

            // Compare the paths and remove any duplicates (accounts for multiple occurences from reply threads)
            var uniquePaths = uncPaths.reduce(function(a,b)
            {
                if(a.indexOf(b) < 0)
                {
                    a.push(b);
                }

                return a;
            }, []);

            console.log("Unique paths: " + uniquePaths.length);

            const pElement = document.createElement("p");
            const divElement = document.getElementById("div1");
            
            const pElements = [];
            
            // TODO: Create a p element and a corresponding copy button for each element in the array
            for(let i = 0; i < uniquePaths.length; i++)
            {
                var node = document.createTextNode(uncPaths[i] + "\n\n");
                pElement.appendChild(node);
                divElement.appendChild(pElement);
            }

            document.getElementById("uncPath").innerHTML = "Match found.";
        }
        else
        {
            document.getElementById("uncPath").innerHTML = "No match found.";
            document.getElementById("numberOfPaths").innerHTML = "";
        }
    }

    Office.onReady((info) => 
    {
        if (info.host === Office.HostType.Outlook) {

            // Set up ItemChanged event
            Office.context.mailbox.addHandlerAsync(Office.EventType.ItemChanged, ItemChanged);

            UpdateTaskPaneUI(Office.context.mailbox.item);
        }
    });

</script>